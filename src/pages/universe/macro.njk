---
layout: layouts/universe.njk
title: Macro Cycle Dashboard
permalink: /universe/macro/
---

{#
  ============================================================================
  MACRO CYCLE DASHBOARD - Live Data Display
  ============================================================================
  All data fetched live from FRED API via Cloudflare Worker proxy.
  ISM PMI requires manual input (removed from FRED in 2016).

  Data Source: FRED (Federal Reserve Economic Data)
  Proxy: https://fred-proxy.ethan-109.workers.dev
  ============================================================================
#}

<div id="macro-app" class="min-h-screen">
  <!-- Header -->
  <div class="border-b border-indigo-500/20 bg-gray-900/50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <a href="/universe/" class="text-xs text-indigo-400 hover:text-indigo-300 mb-1 inline-block">&larr; Dashboard</a>
          <h1 class="text-xl font-semibold text-gray-100">Macro Cycle Dashboard</h1>
          <p class="text-xs text-gray-500 mt-1">GMI/Bittel Framework | <span id="data-status" class="text-yellow-400">Loading...</span></p>
        </div>
        <div class="flex flex-wrap gap-4 sm:gap-6 text-center">
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Cycle Score</p>
            <p id="cycle-score" class="text-2xl font-bold text-green-400">--</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Season</p>
            <p id="cycle-season" class="text-lg font-semibold text-green-400">--</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Signal</p>
            <p id="main-signal" class="text-lg font-semibold text-green-400">--</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6">

    <!-- Cycle Meter -->
    <div class="universe-card rounded-lg p-6 mb-6">
      <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Macro Cycle Position</h2>
      <div class="relative">
        <div class="h-8 rounded-full bg-gradient-to-r from-blue-600 via-green-500 via-yellow-500 to-red-500 relative overflow-hidden">
          <div id="cycle-needle" class="absolute top-0 bottom-0 w-1 bg-white shadow-lg transition-all duration-500" style="left: 50%">
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-xs text-gray-400">
          <span>WINTER</span>
          <span>SPRING</span>
          <span>SUMMER</span>
          <span>FALL</span>
        </div>
      </div>
    </div>

    <!-- Probability Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Bullish</p>
        <p id="prob-bullish" class="text-2xl font-bold text-green-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Neutral</p>
        <p id="prob-neutral" class="text-2xl font-bold text-yellow-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Caution</p>
        <p id="prob-caution" class="text-2xl font-bold text-orange-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Bearish</p>
        <p id="prob-bearish" class="text-2xl font-bold text-red-400">--%</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Column: Data Cards -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Net Liquidity -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">US Net Liquidity</h3>
              <span id="liq-signal" class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">--</span>
            </div>
            <p id="net-liquidity" class="text-2xl font-bold text-gray-100">$--</p>
            <p class="text-xs text-gray-500 mt-1">Fed Balance Sheet - TGA - RRP</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">YoY Change</span>
                <span id="liq-yoy" class="text-green-400">--%</span>
              </div>
            </div>
          </div>

          <!-- Financial Conditions -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Financial Conditions</h3>
              <span id="fci-signal" class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">--</span>
            </div>
            <p id="fci-score" class="text-2xl font-bold text-gray-100">--</p>
            <p class="text-xs text-gray-500 mt-1">Composite Index (0-100)</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50 grid grid-cols-3 gap-2 text-xs">
              <div>
                <p class="text-gray-500">DXY</p>
                <p id="fci-dxy" class="text-gray-300">--</p>
              </div>
              <div>
                <p class="text-gray-500">HY Spread</p>
                <p id="fci-hy" class="text-gray-300">--%</p>
              </div>
              <div>
                <p class="text-gray-500">Curve</p>
                <p id="fci-curve" class="text-gray-300">--%</p>
              </div>
            </div>
          </div>

          <!-- Business Cycle -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Business Cycle</h3>
              <span id="mfg-signal" class="text-xs px-2 py-0.5 rounded bg-yellow-500/20 text-yellow-400">--</span>
            </div>
            <p id="ism-value" class="text-2xl font-bold text-gray-100">--</p>
            <p class="text-xs text-gray-500 mt-1">ISM Manufacturing PMI</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50 space-y-1">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">Mfg Composite</span>
                <span id="mfg-composite" class="text-gray-300">--</span>
              </div>
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">ISM 3Mo Momentum</span>
                <span id="ism-momentum" class="text-gray-300">--</span>
              </div>
            </div>
          </div>

          <!-- BTC Analysis -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">BTC vs Fair Value</h3>
              <span id="btc-signal" class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">--</span>
            </div>
            <p id="btc-discount" class="text-2xl font-bold text-green-400">--</p>
            <p class="text-xs text-gray-500 mt-1">Discount to liquidity-implied FV</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">Fair Value</span>
                <span id="btc-fair-value" class="text-gray-300">$--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Manufacturing Secondary Indicators -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Manufacturing Indicators (FRED)</h2>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div>
              <p class="text-xs text-gray-500 mb-1">Industrial Prod</p>
              <p id="ipman-value" class="text-lg font-bold text-gray-100">--</p>
              <p id="ipman-yoy" class="text-xs text-gray-400">YoY: --%</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Capacity Util</p>
              <p id="mcumfn-value" class="text-lg font-bold text-gray-100">--%</p>
              <p id="mcumfn-signal" class="text-xs text-gray-400">--</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Durable Orders</p>
              <p id="dgorder-value" class="text-lg font-bold text-gray-100">--</p>
              <p id="dgorder-yoy" class="text-xs text-gray-400">YoY: --%</p>
            </div>
          </div>
        </div>

        <!-- Full Scorecard -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Indicator Scorecard</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left py-2 text-gray-500 font-medium">Indicator</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Value</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Signal</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Weight</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Score</th>
                </tr>
              </thead>
              <tbody id="scorecard-body">
                <tr><td colspan="5" class="py-4 text-center text-gray-500">Loading FRED data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Column: Controls & Info -->
      <div class="space-y-6">

        <!-- ISM PMI Input -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-2">ISM Manufacturing PMI</h2>
          <p class="text-xs text-gray-500 mb-3">Not available on FRED. Enter latest value:</p>
          <div class="space-y-3">
            <div class="flex gap-2">
              <input type="number" id="ism-input" step="0.1" value="" placeholder="e.g. 49.2" class="flex-1 bg-gray-900/50 border border-indigo-500/30 rounded px-3 py-2 text-gray-100 text-lg font-mono focus:outline-none focus:border-indigo-500">
              <button onclick="MacroApp.updateIsm()" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded text-sm transition-colors">
                Set
              </button>
            </div>
            <div class="text-xs text-gray-500 space-y-1">
              <p class="font-semibold text-gray-400">Find latest ISM PMI:</p>
              <a href="https://www.investing.com/economic-calendar/ism-manufacturing-pmi-173" target="_blank" class="block text-indigo-400 hover:text-indigo-300">→ Investing.com</a>
              <a href="https://tradingeconomics.com/united-states/business-confidence" target="_blank" class="block text-indigo-400 hover:text-indigo-300">→ Trading Economics</a>
              <a href="https://www.ismworld.org" target="_blank" class="block text-indigo-400 hover:text-indigo-300">→ ISM Official (paid)</a>
            </div>
          </div>
        </div>

        <!-- BTC Price Input -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">BTC Price</h2>
          <div class="space-y-3">
            <input type="number" id="btc-input" value="" placeholder="Loading..." class="w-full bg-gray-900/50 border border-indigo-500/30 rounded px-3 py-2 text-gray-100 text-lg font-mono focus:outline-none focus:border-indigo-500">
            <div class="grid grid-cols-2 gap-2">
              <button onclick="MacroApp.updateBtc()" class="py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded text-sm transition-colors">
                Update
              </button>
              <button onclick="MacroApp.fetchBtc()" class="py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded text-sm transition-colors">
                Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- Debug Panel -->
        <div class="universe-card rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400">API Debug</h2>
            <button onclick="MacroApp.refreshAll()" class="text-xs px-2 py-1 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-400 rounded transition-colors">
              Refresh All
            </button>
          </div>
          <div class="space-y-2 text-xs">
            <div class="flex justify-between text-gray-500">
              <span>Proxy URL:</span>
              <span id="debug-proxy" class="text-gray-400 font-mono truncate ml-2">--</span>
            </div>
            <div class="border-t border-gray-700/50 pt-2 mt-2">
              <p class="text-gray-500 mb-2">FRED Series Status:</p>
              <div id="debug-series" class="space-y-1 font-mono text-xs max-h-48 overflow-y-auto">
                <p class="text-gray-600">Loading...</p>
              </div>
            </div>
            <div class="border-t border-gray-700/50 pt-2 mt-2">
              <div class="flex justify-between text-gray-500">
                <span>BTC Source:</span>
                <span id="debug-btc" class="text-gray-400">--</span>
              </div>
              <div class="flex justify-between text-gray-500 mt-1">
                <span>ISM Source:</span>
                <span id="debug-ism" class="text-gray-400">Manual input</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Interpretation Guide -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Interpretation</h2>
          <div class="space-y-3 text-xs text-gray-400">
            <div>
              <p class="text-green-400 font-semibold">SUMMER (75-100)</p>
              <p>Peak expansion. Risk assets favored.</p>
            </div>
            <div>
              <p class="text-yellow-400 font-semibold">SPRING (55-75)</p>
              <p>Recovery phase. Accumulate risk.</p>
            </div>
            <div>
              <p class="text-orange-400 font-semibold">FALL (35-55)</p>
              <p>Late cycle. Reduce risk.</p>
            </div>
            <div>
              <p class="text-blue-400 font-semibold">WINTER (0-35)</p>
              <p>Contraction. Defensive posture.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div id="error-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
  <div class="universe-card rounded-lg p-6 max-w-md mx-4">
    <h3 class="text-lg font-bold text-red-400 mb-3">Data Load Error</h3>
    <p id="error-message" class="text-sm text-gray-300 mb-4">Failed to load required data.</p>
    <div class="flex gap-3">
      <button onclick="MacroApp.refreshAll()" class="flex-1 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded text-sm transition-colors">
        Retry
      </button>
      <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded text-sm transition-colors">
        Dismiss
      </button>
    </div>
  </div>
</div>

<script>
// ============================================================================
// CONFIGURATION
// ============================================================================
const FRED_PROXY_URL = 'https://fred-proxy.ethan-109.workers.dev';

// FRED series configuration
// Note: NAPM (ISM PMI) was removed from FRED in 2016 - requires manual input
const FRED_SERIES = [
  // Liquidity
  { id: 'WALCL', key: 'fedBalanceSheet', limit: 55, label: 'Fed Balance Sheet' },
  { id: 'WTREGEN', key: 'tga', limit: 5, label: 'Treasury General Account' },
  { id: 'RRPONTSYD', key: 'rrp', limit: 5, label: 'Reverse Repo' },
  // Financial Conditions
  { id: 'BAMLH0A0HYM2', key: 'hySpread', limit: 5, label: 'HY Credit Spread' },
  { id: 'T10Y2Y', key: 'yieldCurve', limit: 5, label: '10Y-2Y Yield Curve' },
  { id: 'DTWEXBGS', key: 'dxy', limit: 5, label: 'Trade-Weighted Dollar' },
  // Manufacturing (secondary indicators to support ISM)
  { id: 'IPMAN', key: 'ipman', limit: 13, label: 'Industrial Production: Mfg' },
  { id: 'MCUMFN', key: 'mcumfn', limit: 5, label: 'Capacity Utilization: Mfg' },
  { id: 'DGORDER', key: 'dgorder', limit: 13, label: 'Durable Goods Orders' }
];

// ============================================================================
// MACRO APP
// ============================================================================
const MacroApp = {
  btcPrice: null,
  ismValue: null,
  ismPrevious: null,
  macroData: {},
  debugInfo: {},

  async init() {
    // Check if proxy URL is configured
    if (!FRED_PROXY_URL) {
      this.showError('FRED_PROXY_URL is not configured. Please set the proxy URL to fetch live data.');
      return;
    }

    // Update debug panel with proxy URL
    document.getElementById('debug-proxy').textContent = FRED_PROXY_URL.replace('https://', '');

    // Fetch all data in parallel
    await Promise.all([
      this.fetchLiveMacroData(),
      this.fetchBtc()
    ]);
  },

  async fetchLiveMacroData() {
    try {
      document.getElementById('data-status').textContent = 'Fetching FRED data...';
      document.getElementById('data-status').className = 'text-yellow-400';

      // Reset debug info
      this.debugInfo = {};

      // Fetch all series in parallel
      const results = await Promise.all(
        FRED_SERIES.map(async s => {
          const url = `${FRED_PROXY_URL}/series/observations?series_id=${s.id}&limit=${s.limit}`;
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            return { ...s, data, success: true, error: null };
          } catch (e) {
            return { ...s, data: null, success: false, error: e.message };
          }
        })
      );

      // Process results and update debug panel
      let latestDate = null;
      let failedSeries = [];
      const debugHtml = [];

      results.forEach(r => {
        if (r.success && r.data?.observations?.length > 0) {
          const obs = r.data.observations;
          const val = parseFloat(obs[0].value);
          const date = obs[0].date;

          if (!isNaN(val)) {
            this.macroData[r.key] = val;

            // Track latest date
            if (!latestDate || date > latestDate) {
              latestDate = date;
            }

            // Store debug info
            this.debugInfo[r.id] = { value: val, date, success: true };
            debugHtml.push(`<div class="flex justify-between"><span class="text-green-400">${r.id}</span><span class="text-gray-400">${val.toFixed(2)} (${date})</span></div>`);

            // Get YoY for Fed Balance Sheet (need observation from ~52 weeks ago)
            if (r.key === 'fedBalanceSheet' && obs.length >= 52) {
              const yoyVal = parseFloat(obs[51].value);
              if (!isNaN(yoyVal)) {
                this.macroData.fedBalanceSheetYoY = yoyVal;
              }
            }

            // Get YoY for Industrial Production
            if (r.key === 'ipman' && obs.length >= 12) {
              const yoyVal = parseFloat(obs[11].value);
              if (!isNaN(yoyVal)) {
                this.macroData.ipmanYoY = yoyVal;
              }
            }

            // Get YoY for Durable Goods
            if (r.key === 'dgorder' && obs.length >= 12) {
              const yoyVal = parseFloat(obs[11].value);
              if (!isNaN(yoyVal)) {
                this.macroData.dgorderYoY = yoyVal;
              }
            }
          } else {
            failedSeries.push(r.id);
            this.debugInfo[r.id] = { success: false, error: 'Invalid value' };
            debugHtml.push(`<div class="flex justify-between"><span class="text-red-400">${r.id}</span><span class="text-red-400">Invalid</span></div>`);
          }
        } else {
          failedSeries.push(r.id);
          this.debugInfo[r.id] = { success: false, error: r.error || 'No data' };
          debugHtml.push(`<div class="flex justify-between"><span class="text-red-400">${r.id}</span><span class="text-red-400">${r.error || 'No data'}</span></div>`);
        }
      });

      // Update debug panel
      document.getElementById('debug-series').innerHTML = debugHtml.join('');

      // Check if we have all required data (excluding ISM which is manual)
      const requiredSeries = ['WALCL', 'WTREGEN', 'RRPONTSYD', 'BAMLH0A0HYM2', 'T10Y2Y', 'DTWEXBGS'];
      const missingRequired = failedSeries.filter(s => requiredSeries.includes(s));

      if (missingRequired.length > 0) {
        this.showError(`Failed to fetch required FRED series: ${missingRequired.join(', ')}`);
        document.getElementById('data-status').textContent = `Error | ${missingRequired.length} series failed`;
        document.getElementById('data-status').className = 'text-red-400';
        return;
      }

      // Update status with latest date
      if (latestDate) {
        const ismStatus = this.ismValue ? '' : ' | Enter ISM';
        document.getElementById('data-status').textContent = `Live | Latest: ${latestDate}${ismStatus}`;
        document.getElementById('data-status').className = this.ismValue ? 'text-green-400' : 'text-yellow-400';
      }

      // Update manufacturing indicators display
      this.updateManufacturingDisplay();

      // Calculate if we have BTC price
      if (this.btcPrice) {
        this.calculate();
      }

    } catch (e) {
      console.error('Failed to fetch live FRED data:', e);
      this.showError(`Failed to fetch FRED data: ${e.message}`);
      document.getElementById('data-status').textContent = 'Error | Fetch failed';
      document.getElementById('data-status').className = 'text-red-400';
    }
  },

  updateManufacturingDisplay() {
    const d = this.macroData;

    // Industrial Production
    if (d.ipman) {
      document.getElementById('ipman-value').textContent = d.ipman.toFixed(1);
      if (d.ipmanYoY) {
        const yoy = ((d.ipman - d.ipmanYoY) / d.ipmanYoY * 100);
        document.getElementById('ipman-yoy').textContent = `YoY: ${yoy > 0 ? '+' : ''}${yoy.toFixed(1)}%`;
        document.getElementById('ipman-yoy').className = yoy > 0 ? 'text-xs text-green-400' : 'text-xs text-red-400';
      }
    }

    // Capacity Utilization
    if (d.mcumfn) {
      document.getElementById('mcumfn-value').textContent = d.mcumfn.toFixed(1) + '%';
      let signal = 'Neutral';
      if (d.mcumfn > 78) signal = 'Strong';
      else if (d.mcumfn > 75) signal = 'Normal';
      else if (d.mcumfn > 70) signal = 'Weak';
      else signal = 'Very Weak';
      document.getElementById('mcumfn-signal').textContent = signal;
    }

    // Durable Goods
    if (d.dgorder) {
      document.getElementById('dgorder-value').textContent = '$' + (d.dgorder / 1000).toFixed(0) + 'B';
      if (d.dgorderYoY) {
        const yoy = ((d.dgorder - d.dgorderYoY) / d.dgorderYoY * 100);
        document.getElementById('dgorder-yoy').textContent = `YoY: ${yoy > 0 ? '+' : ''}${yoy.toFixed(1)}%`;
        document.getElementById('dgorder-yoy').className = yoy > 0 ? 'text-xs text-green-400' : 'text-xs text-red-400';
      }
    }
  },

  updateIsm() {
    const input = document.getElementById('ism-input');
    const value = parseFloat(input.value);
    if (value > 0 && value < 100) {
      // Store previous for momentum calc (simple approach - 3 points lower as estimate)
      this.ismPrevious = this.ismValue || (value - 1);
      this.ismValue = value;
      document.getElementById('debug-ism').textContent = `Manual (${value})`;

      // Update status
      const status = document.getElementById('data-status');
      if (status.textContent.includes('Enter ISM')) {
        status.textContent = status.textContent.replace(' | Enter ISM', '');
        status.className = 'text-green-400';
      }

      if (this.btcPrice && Object.keys(this.macroData).length > 0) {
        this.calculate();
      }
    }
  },

  updateBtc() {
    const price = parseFloat(document.getElementById('btc-input').value);
    if (price > 0) {
      this.btcPrice = price;
      document.getElementById('debug-btc').textContent = 'Manual input';
      if (Object.keys(this.macroData).length > 0) {
        this.calculate();
      }
    }
  },

  async fetchBtc() {
    try {
      document.getElementById('debug-btc').textContent = 'Fetching...';
      const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (data.bitcoin?.usd) {
        this.btcPrice = data.bitcoin.usd;
        document.getElementById('btc-input').value = this.btcPrice;
        document.getElementById('debug-btc').textContent = `CoinGecko ($${this.btcPrice.toLocaleString()})`;

        // Calculate if we have macro data
        if (Object.keys(this.macroData).length > 0) {
          this.calculate();
        }
      } else {
        throw new Error('No BTC price in response');
      }
    } catch (e) {
      console.error('Failed to fetch BTC price:', e);
      document.getElementById('debug-btc').textContent = `Error: ${e.message}`;
      document.getElementById('btc-input').placeholder = 'Enter manually';
    }
  },

  async refreshAll() {
    document.getElementById('error-modal').classList.add('hidden');
    this.macroData = {};
    this.btcPrice = null;
    document.getElementById('btc-input').value = '';
    await this.init();
  },

  showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-modal').classList.remove('hidden');
  },

  // Calculate manufacturing composite from FRED data (0-100 scale)
  calculateMfgComposite() {
    const d = this.macroData;
    let score = 50; // neutral baseline

    // Industrial Production YoY contribution
    if (d.ipman && d.ipmanYoY) {
      const ipYoY = ((d.ipman - d.ipmanYoY) / d.ipmanYoY * 100);
      score += ipYoY * 3; // scale: +3% YoY = +9 points
    }

    // Capacity Utilization contribution
    if (d.mcumfn) {
      score += (d.mcumfn - 75) * 2; // 75% is neutral, +5% = +10 points
    }

    // Durable Goods YoY contribution
    if (d.dgorder && d.dgorderYoY) {
      const dgYoY = ((d.dgorder - d.dgorderYoY) / d.dgorderYoY * 100);
      score += dgYoY * 1.5; // scale: +5% YoY = +7.5 points
    }

    return Math.max(0, Math.min(100, score));
  },

  calculate() {
    const d = this.macroData;

    // Ensure we have minimum required data
    if (!d.fedBalanceSheet || !d.tga || d.rrp === undefined || !d.hySpread || d.yieldCurve === undefined || !d.dxy) {
      console.error('Missing required macro data');
      return;
    }

    // Net Liquidity
    const fedBs = d.fedBalanceSheet * 1e6;
    const tga = d.tga * 1e6;
    const rrp = d.rrp * 1e9;
    const netLiq = fedBs - tga - rrp;

    // YoY change
    const fedBsYoY = (d.fedBalanceSheetYoY || d.fedBalanceSheet) * 1e6;
    const netLiqYoY = ((fedBs - fedBsYoY) / fedBsYoY) * 100;

    // Financial Conditions Index (0-100, higher = looser)
    let fci = 50;
    fci += (110 - d.dxy) * 2.5;  // Dollar weakness
    fci += (5 - d.hySpread) * 6;  // Tight spreads
    fci += d.yieldCurve * 10;  // Steep curve
    fci = Math.max(0, Math.min(100, fci));

    // BTC Fair Value (liquidity-based)
    const baseLiq = 5.95e12;
    const baseBtc = 90000;
    const btcFairValue = baseBtc * Math.pow(netLiq / baseLiq, 1.4);
    const btcDiscount = ((btcFairValue - this.btcPrice) / btcFairValue) * 100;

    // Manufacturing composite from FRED
    const mfgComposite = this.calculateMfgComposite();

    // ISM momentum (if available)
    const ismMomentum = this.ismValue && this.ismPrevious ? this.ismValue - this.ismPrevious : 0;

    // Calculate scores
    const scores = [];

    // Net Liquidity YoY (20%)
    let liqScore = 0, liqSignal = 'Neutral';
    if (netLiqYoY > 5) { liqScore = 20; liqSignal = 'Bullish'; }
    else if (netLiqYoY > 0) { liqScore = 10; liqSignal = 'Neutral'; }
    else if (netLiqYoY > -5) { liqScore = 0; liqSignal = 'Caution'; }
    else { liqScore = -10; liqSignal = 'Bearish'; }
    scores.push({ name: 'Net Liquidity YoY', value: netLiqYoY.toFixed(1) + '%', signal: liqSignal, weight: 20, score: liqScore });

    // DXY (15%)
    let dxyScore = 0, dxySignal = 'Neutral';
    if (d.dxy < 105) { dxyScore = 15; dxySignal = 'Bullish'; }
    else if (d.dxy < 110) { dxyScore = 7; dxySignal = 'Neutral'; }
    else if (d.dxy < 115) { dxyScore = 0; dxySignal = 'Caution'; }
    else { dxyScore = -8; dxySignal = 'Bearish'; }
    scores.push({ name: 'Trade-Weighted Dollar', value: d.dxy.toFixed(1), signal: dxySignal, weight: 15, score: dxyScore });

    // HY Spread (10%)
    let hyScore = 0, hySignal = 'Neutral';
    if (d.hySpread < 4) { hyScore = 10; hySignal = 'Bullish'; }
    else if (d.hySpread < 5) { hyScore = 5; hySignal = 'Neutral'; }
    else if (d.hySpread < 6) { hyScore = 0; hySignal = 'Caution'; }
    else { hyScore = -5; hySignal = 'Bearish'; }
    scores.push({ name: 'HY Credit Spread', value: d.hySpread.toFixed(2) + '%', signal: hySignal, weight: 10, score: hyScore });

    // Yield Curve (10%)
    let curveScore = 0, curveSignal = 'Neutral';
    if (d.yieldCurve > 0.5) { curveScore = 10; curveSignal = 'Bullish'; }
    else if (d.yieldCurve > 0) { curveScore = 5; curveSignal = 'Neutral'; }
    else if (d.yieldCurve > -0.3) { curveScore = 0; curveSignal = 'Caution'; }
    else { curveScore = -5; curveSignal = 'Bearish'; }
    scores.push({ name: '10Y-2Y Yield Curve', value: d.yieldCurve.toFixed(2) + '%', signal: curveSignal, weight: 10, score: curveScore });

    // ISM or Mfg Composite (15%)
    let mfgScore = 0, mfgSignal = 'Neutral';
    const ismVal = this.ismValue || null;

    if (ismVal) {
      // Use ISM PMI if available
      if (ismVal > 52) { mfgScore = 15; mfgSignal = 'Bullish'; }
      else if (ismVal > 50) { mfgScore = 7; mfgSignal = 'Neutral'; }
      else if (ismVal > 48) { mfgScore = 0; mfgSignal = 'Caution'; }
      else { mfgScore = -8; mfgSignal = 'Bearish'; }
      scores.push({ name: 'ISM Manufacturing', value: ismVal.toFixed(1), signal: mfgSignal, weight: 15, score: mfgScore });
    } else {
      // Fall back to FRED manufacturing composite
      if (mfgComposite > 60) { mfgScore = 15; mfgSignal = 'Bullish'; }
      else if (mfgComposite > 50) { mfgScore = 7; mfgSignal = 'Neutral'; }
      else if (mfgComposite > 40) { mfgScore = 0; mfgSignal = 'Caution'; }
      else { mfgScore = -8; mfgSignal = 'Bearish'; }
      scores.push({ name: 'Mfg Composite (FRED)', value: mfgComposite.toFixed(0), signal: mfgSignal, weight: 15, score: mfgScore });
    }

    // Momentum (10%) - ISM momentum if available, otherwise mfg composite trend
    let momScore = 0, momSignal = 'Neutral';
    if (ismVal && ismMomentum !== 0) {
      if (ismMomentum > 1) { momScore = 10; momSignal = 'Bullish'; }
      else if (ismMomentum > 0) { momScore = 5; momSignal = 'Neutral'; }
      else if (ismMomentum > -1) { momScore = 0; momSignal = 'Caution'; }
      else { momScore = -5; momSignal = 'Bearish'; }
      scores.push({ name: 'ISM 3Mo Momentum', value: (ismMomentum > 0 ? '+' : '') + ismMomentum.toFixed(1), signal: momSignal, weight: 10, score: momScore });
    } else {
      // Use capacity utilization as proxy
      if (d.mcumfn > 78) { momScore = 10; momSignal = 'Bullish'; }
      else if (d.mcumfn > 75) { momScore = 5; momSignal = 'Neutral'; }
      else if (d.mcumfn > 72) { momScore = 0; momSignal = 'Caution'; }
      else { momScore = -5; momSignal = 'Bearish'; }
      scores.push({ name: 'Capacity Utilization', value: d.mcumfn.toFixed(1) + '%', signal: momSignal, weight: 10, score: momScore });
    }

    // BTC vs Fair Value (20%)
    let btcScore = 0, btcSignal = 'Neutral';
    if (btcDiscount > 20) { btcScore = 20; btcSignal = 'Bullish'; }
    else if (btcDiscount > 10) { btcScore = 15; btcSignal = 'Bullish'; }
    else if (btcDiscount > 0) { btcScore = 5; btcSignal = 'Neutral'; }
    else if (btcDiscount > -20) { btcScore = 0; btcSignal = 'Caution'; }
    else { btcScore = -10; btcSignal = 'Bearish'; }
    scores.push({ name: 'BTC vs Fair Value', value: (btcDiscount > 0 ? '+' : '') + btcDiscount.toFixed(1) + '%', signal: btcSignal, weight: 20, score: btcScore });

    // Total score
    const totalScore = scores.reduce((a, s) => a + s.score, 0);
    const maxScore = scores.reduce((a, s) => a + s.weight, 0);
    const cyclePos = 50 + (totalScore / maxScore) * 50;

    // Season
    let season, mainSignal;
    if (cyclePos >= 75) { season = 'SUMMER'; mainSignal = 'Risk On'; }
    else if (cyclePos >= 55) { season = 'SPRING'; mainSignal = 'Accumulate'; }
    else if (cyclePos >= 35) { season = 'FALL'; mainSignal = 'Reduce Risk'; }
    else { season = 'WINTER'; mainSignal = 'Defensive'; }

    // Update UI
    this.updateUI({
      netLiq, netLiqYoY, fci, mfgComposite,
      btcFairValue, btcDiscount, ismMomentum,
      scores, cyclePos, season, mainSignal,
      liqSignal, btcSignal, mfgSignal
    });
  },

  updateUI(data) {
    const fmt = (n) => '$' + (n / 1e12).toFixed(2) + 'T';
    const d = this.macroData;

    // Header
    document.getElementById('cycle-score').textContent = data.cyclePos.toFixed(0);
    document.getElementById('cycle-season').textContent = data.season;
    document.getElementById('main-signal').textContent = data.mainSignal;

    // Season colors
    const seasonColors = { 'SUMMER': 'text-green-400', 'SPRING': 'text-yellow-400', 'FALL': 'text-orange-400', 'WINTER': 'text-blue-400' };
    document.getElementById('cycle-season').className = 'text-lg font-semibold ' + (seasonColors[data.season] || 'text-gray-400');
    document.getElementById('cycle-score').className = 'text-2xl font-bold ' + (seasonColors[data.season] || 'text-gray-400');

    // Needle position
    document.getElementById('cycle-needle').style.left = data.cyclePos + '%';

    // Probability grid
    const bull = Math.max(0, (data.cyclePos - 50) * 2);
    const bear = Math.max(0, (50 - data.cyclePos) * 2);
    document.getElementById('prob-bullish').textContent = bull.toFixed(0) + '%';
    document.getElementById('prob-neutral').textContent = Math.max(0, 100 - bull - bear - 20).toFixed(0) + '%';
    document.getElementById('prob-caution').textContent = Math.min(30, Math.max(0, 40 - Math.abs(data.cyclePos - 50))).toFixed(0) + '%';
    document.getElementById('prob-bearish').textContent = bear.toFixed(0) + '%';

    // Data cards
    document.getElementById('net-liquidity').textContent = fmt(data.netLiq);
    document.getElementById('liq-yoy').textContent = (data.netLiqYoY > 0 ? '+' : '') + data.netLiqYoY.toFixed(1) + '%';
    document.getElementById('liq-signal').textContent = data.liqSignal;

    document.getElementById('fci-score').textContent = data.fci.toFixed(0);
    document.getElementById('fci-dxy').textContent = d.dxy.toFixed(1);
    document.getElementById('fci-hy').textContent = d.hySpread.toFixed(2) + '%';
    document.getElementById('fci-curve').textContent = d.yieldCurve.toFixed(2) + '%';

    // ISM / Manufacturing
    document.getElementById('ism-value').textContent = this.ismValue ? this.ismValue.toFixed(1) : '--';
    document.getElementById('mfg-composite').textContent = data.mfgComposite.toFixed(0);
    document.getElementById('ism-momentum').textContent = this.ismValue ?
      ((data.ismMomentum > 0 ? '+' : '') + data.ismMomentum.toFixed(1)) : '--';
    document.getElementById('mfg-signal').textContent = data.mfgSignal;

    document.getElementById('btc-discount').textContent = (data.btcDiscount > 0 ? '+' : '') + data.btcDiscount.toFixed(1) + '%';
    document.getElementById('btc-fair-value').textContent = '$' + Math.round(data.btcFairValue).toLocaleString();
    document.getElementById('btc-signal').textContent = data.btcSignal;

    // Signal badge colors
    const signalColors = {
      'Bullish': 'bg-green-500/20 text-green-400',
      'Neutral': 'bg-yellow-500/20 text-yellow-400',
      'Caution': 'bg-orange-500/20 text-orange-400',
      'Bearish': 'bg-red-500/20 text-red-400'
    };
    document.getElementById('liq-signal').className = 'text-xs px-2 py-0.5 rounded ' + (signalColors[data.liqSignal] || '');
    document.getElementById('mfg-signal').className = 'text-xs px-2 py-0.5 rounded ' + (signalColors[data.mfgSignal] || '');
    document.getElementById('btc-signal').className = 'text-xs px-2 py-0.5 rounded ' + (signalColors[data.btcSignal] || '');

    // Scorecard table
    document.getElementById('scorecard-body').innerHTML = data.scores.map(s => {
      const signalClass = signalColors[s.signal]?.split(' ')[1] || 'text-gray-400';
      const scoreClass = s.score > 0 ? 'text-green-400' : s.score < 0 ? 'text-red-400' : 'text-gray-400';
      return `
        <tr class="border-b border-gray-800/50">
          <td class="py-2 text-gray-300">${s.name}</td>
          <td class="py-2 text-right text-gray-100 font-mono">${s.value}</td>
          <td class="py-2 text-right ${signalClass}">${s.signal}</td>
          <td class="py-2 text-right text-gray-500">${s.weight}%</td>
          <td class="py-2 text-right font-semibold ${scoreClass}">${s.score > 0 ? '+' : ''}${s.score}</td>
        </tr>
      `;
    }).join('');
  }
};

document.addEventListener('DOMContentLoaded', () => MacroApp.init());
</script>
