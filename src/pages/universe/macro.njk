---
layout: layouts/universe.njk
title: Macro Cycle Dashboard
permalink: /universe/macro/
---

{#
  ============================================================================
  MACRO CYCLE DASHBOARD v2.1 - GMI/Bittel Framework
  ============================================================================
  
  CHANGELOG v2.1:
  - Fixed WILL5000PRFC series (now uses WILL5000IND with price correction)
  - Fixed Net Liquidity YoY calculation (now includes TGA/RRP from 52 weeks ago)
  - Fixed probability grid to sum to 100%
  - Added data freshness indicators per metric
  - Added refresh button
  - Added graceful degradation for failed metrics
  - Improved error handling and validation
  
  Data Sources:
  - FRED: US M2, Net Liquidity, Bank Lending, Buffett Indicator, Financial Conditions
  - ECB: Euro Area M3 (via proxy)
  - IMF: China M2 (via proxy)
  - Manual: ISM Manufacturing PMI

  Proxy: https://fred-proxy.ethan-109.workers.dev (or new global-macro-proxy)

  Scorecard (100% weight total):
  - Global M2 YoY: 15%
  - Net Liquidity YoY: 15%
  - Bank Lending YoY: 10%
  - Trade-Weighted Dollar: 10%
  - HY Credit Spread: 10%
  - Yield Curve (10Y-2Y): 10%
  - ISM Manufacturing: 10%
  - Buffett Indicator: 10%
  - Manufacturing Composite: 10%
  ============================================================================
#}

<div id="macro-app" class="min-h-screen">
  <!-- Header -->
  <div class="border-b border-indigo-500/20 bg-gray-900/50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <a href="/universe/" class="text-xs text-indigo-400 hover:text-indigo-300 mb-1 inline-block">&larr; Dashboard</a>
          <h1 class="text-xl font-semibold text-gray-100">Macro Cycle Dashboard</h1>
          <p class="text-xs text-gray-500 mt-1">
            GMI/Bittel Framework v2.1 | 
            <span id="data-status" class="text-yellow-400">Loading...</span>
            <button onclick="MacroApp.refresh()" class="ml-2 text-indigo-400 hover:text-indigo-300" title="Refresh data">
              <svg class="inline w-3 h-3" id="refresh-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </button>
          </p>
        </div>
        <div class="flex flex-wrap gap-4 sm:gap-6 text-center">
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Cycle Score</p>
            <p id="cycle-score" class="text-2xl font-bold text-green-400">--</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Season</p>
            <p id="cycle-season" class="text-lg font-semibold text-green-400">--</p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wider text-gray-500">Signal</p>
            <p id="main-signal" class="text-lg font-semibold text-green-400">--</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6">

    <!-- Cycle Meter -->
    <div class="universe-card rounded-lg p-6 mb-6">
      <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Macro Cycle Position</h2>
      <div class="relative">
        <div class="h-8 rounded-full bg-gradient-to-r from-blue-600 via-green-500 via-yellow-500 to-red-500 relative overflow-hidden">
          <div id="cycle-needle" class="absolute top-0 bottom-0 w-1 bg-white shadow-lg transition-all duration-500" style="left: 50%">
            <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-white"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2 text-xs text-gray-400">
          <span>WINTER</span>
          <span>SPRING</span>
          <span>SUMMER</span>
          <span>FALL</span>
        </div>
      </div>
    </div>

    <!-- Probability Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Bullish</p>
        <p id="prob-bullish" class="text-2xl font-bold text-green-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Neutral</p>
        <p id="prob-neutral" class="text-2xl font-bold text-yellow-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Caution</p>
        <p id="prob-caution" class="text-2xl font-bold text-orange-400">--%</p>
      </div>
      <div class="universe-card rounded-lg p-4 text-center">
        <p class="text-xs text-gray-500 uppercase mb-1">Bearish</p>
        <p id="prob-bearish" class="text-2xl font-bold text-red-400">--%</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Column: Data Cards -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <!-- Global M2 -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Global M2</h3>
              <span id="m2-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="global-m2" class="text-2xl font-bold text-gray-100">$--T</p>
            <p class="text-xs text-gray-500 mt-1">US + Euro + Japan + China</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">YoY Change</span>
                <span id="m2-yoy" class="text-gray-400">--%</span>
              </div>
              <div class="grid grid-cols-4 gap-1 mt-2 text-xs">
                <div class="text-center">
                  <p class="text-gray-600">US</p>
                  <p id="m2-us-yoy" class="text-gray-400">--%</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-600">EU</p>
                  <p id="m2-eu-yoy" class="text-gray-400">--%</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-600">JP</p>
                  <p id="m2-jp-yoy" class="text-gray-400">--%</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-600">CN</p>
                  <p id="m2-cn-yoy" class="text-gray-400">--%</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Net Liquidity -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">US Net Liquidity</h3>
              <span id="liq-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="net-liquidity" class="text-2xl font-bold text-gray-100">$--</p>
            <p class="text-xs text-gray-500 mt-1">Fed Balance Sheet - TGA - RRP</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">YoY Change</span>
                <span id="liq-yoy" class="text-gray-400">--%</span>
              </div>
            </div>
          </div>

          <!-- Bank Lending -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Bank Lending</h3>
              <span id="lending-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="bank-lending" class="text-2xl font-bold text-gray-100">$--T</p>
            <p class="text-xs text-gray-500 mt-1">Total Loans & Leases</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">YoY Change</span>
                <span id="lending-yoy" class="text-gray-400">--%</span>
              </div>
            </div>
          </div>

          <!-- Buffett Indicator -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Buffett Indicator</h3>
              <span id="buffett-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="buffett-value" class="text-2xl font-bold text-gray-100">--%</p>
            <p class="text-xs text-gray-500 mt-1">Total Market Cap / GDP</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50 grid grid-cols-2 gap-2 text-xs">
              <div>
                <p class="text-gray-500">Wilshire 5000</p>
                <p id="wilshire-value" class="text-gray-300">$--T</p>
              </div>
              <div>
                <p class="text-gray-500">GDP</p>
                <p id="gdp-value" class="text-gray-300">$--T</p>
              </div>
            </div>
          </div>

          <!-- Financial Conditions -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Financial Conditions</h3>
              <span id="fci-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="fci-score" class="text-2xl font-bold text-gray-100">--</p>
            <p class="text-xs text-gray-500 mt-1">Composite Index (0-100)</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50 grid grid-cols-3 gap-2 text-xs">
              <div>
                <p class="text-gray-500">DXY</p>
                <p id="fci-dxy" class="text-gray-300">--</p>
              </div>
              <div>
                <p class="text-gray-500">HY Spread</p>
                <p id="fci-hy" class="text-gray-300">--%</p>
              </div>
              <div>
                <p class="text-gray-500">Curve</p>
                <p id="fci-curve" class="text-gray-300">--%</p>
              </div>
            </div>
          </div>

          <!-- Business Cycle -->
          <div class="universe-card rounded-lg p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Business Cycle</h3>
              <span id="mfg-signal" class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">--</span>
            </div>
            <p id="ism-value" class="text-2xl font-bold text-gray-100">--</p>
            <p class="text-xs text-gray-500 mt-1">ISM Manufacturing PMI</p>
            <div class="mt-3 pt-3 border-t border-gray-700/50 space-y-1">
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">Mfg Composite</span>
                <span id="mfg-composite" class="text-gray-300">--</span>
              </div>
              <div class="flex justify-between text-xs">
                <span class="text-gray-500">Capacity Util</span>
                <span id="cap-util" class="text-gray-300">--%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Manual Input Panel -->
        <div class="universe-card rounded-lg p-5">
          <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4">Manual Inputs</h3>
          <p class="text-xs text-gray-500 mb-4">ISM PMI data is not available via FRED API. Enter current values from <a href="https://www.ismworld.org/supply-management-news-and-reports/reports/ism-report-on-business/" target="_blank" class="text-indigo-400 hover:text-indigo-300">ISM World</a>.</p>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-gray-400 mb-1">ISM Manufacturing PMI</label>
              <input type="number" id="input-ism" step="0.1" placeholder="e.g. 49.2"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 text-sm focus:outline-none focus:border-indigo-500"
                onchange="MacroApp.setISM(this.value)">
            </div>
            <div>
              <label class="block text-xs text-gray-400 mb-1">Previous Month ISM</label>
              <input type="number" id="input-ism-prev" step="0.1" placeholder="e.g. 48.4"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 text-sm focus:outline-none focus:border-indigo-500"
                onchange="MacroApp.setISMPrev(this.value)">
            </div>
          </div>
          <div class="flex items-center gap-4 mt-4">
            <button onclick="MacroApp.calculate()"
              class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium text-white transition-colors">
              Recalculate
            </button>
            <span id="ism-saved-date" class="text-xs text-gray-500"></span>
          </div>
        </div>
      </div>

      <!-- Right Column: Scorecard -->
      <div class="space-y-6">
        <div class="universe-card rounded-lg p-5">
          <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4">Scorecard</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-xs">
              <thead>
                <tr class="text-gray-500 border-b border-gray-700">
                  <th class="pb-2 text-left font-medium">Indicator</th>
                  <th class="pb-2 text-right font-medium">Value</th>
                  <th class="pb-2 text-right font-medium">Signal</th>
                  <th class="pb-2 text-right font-medium">Wt</th>
                  <th class="pb-2 text-right font-medium">Score</th>
                </tr>
              </thead>
              <tbody id="scorecard-body">
                <tr><td colspan="5" class="py-4 text-center text-gray-500">Loading...</td></tr>
              </tbody>
              <tfoot>
                <tr class="border-t border-gray-700 font-semibold">
                  <td class="pt-3 text-gray-300">Total</td>
                  <td></td>
                  <td></td>
                  <td id="total-weight" class="pt-3 text-right text-gray-400">100%</td>
                  <td id="total-score" class="pt-3 text-right text-green-400">--</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Data Sources -->
        <div class="universe-card rounded-lg p-5">
          <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-3">Data Sources</h3>
          <div class="space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-500">Global M2</span>
              <span class="text-gray-400">FRED + ECB + IMF</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Net Liquidity</span>
              <span class="text-gray-400">FRED</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Bank Lending</span>
              <span class="text-gray-400">FRED: TOTLL</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Buffett Indicator</span>
              <span class="text-gray-400">FRED: WILL5000IND / GDP</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">ISM PMI</span>
              <span class="text-gray-400">Manual Input</span>
            </div>
          </div>
        </div>

        <!-- Debug Panel -->
        <details class="universe-card rounded-lg">
          <summary class="p-4 cursor-pointer text-xs font-bold uppercase tracking-widest text-gray-400">
            ▼Debug Info
          </summary>
          <div class="px-4 pb-4 space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-gray-500">Proxy URL</span>
              <span id="debug-proxy" class="text-gray-400 font-mono text-[10px]">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Last Updated</span>
              <span id="debug-timestamp" class="text-gray-400">--</span>
            </div>
            <div id="debug-series" class="mt-2 space-y-1 font-mono text-[10px] text-gray-500 max-h-48 overflow-y-auto">
              <!-- Populated by JS -->
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Methodology -->
    <div class="mt-8 universe-card rounded-lg p-6">
      <h3 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Methodology: GMI/Bittel Framework v2.1</h3>
      <div class="grid md:grid-cols-2 gap-6 text-xs text-gray-400">
        <div>
          <h4 class="text-gray-300 font-semibold mb-2">Liquidity Indicators (30%)</h4>
          <ul class="space-y-1 list-disc list-inside">
            <li><strong>Global M2 YoY (15%):</strong> Sum of US, Euro, Japan, China M2 converted to USD. Primary driver of crypto bull markets.</li>
            <li><strong>Net Liquidity YoY (15%):</strong> Fed Balance Sheet minus TGA and RRP. Direct measure of dollar liquidity.</li>
          </ul>
        </div>
        <div>
          <h4 class="text-gray-300 font-semibold mb-2">Credit Indicators (20%)</h4>
          <ul class="space-y-1 list-disc list-inside">
            <li><strong>Bank Lending YoY (10%):</strong> Total bank loans and leases. Credit impulse indicator.</li>
            <li><strong>HY Credit Spread (10%):</strong> Risk appetite gauge. Tight spreads = risk-on.</li>
          </ul>
        </div>
        <div>
          <h4 class="text-gray-300 font-semibold mb-2">Financial Conditions (20%)</h4>
          <ul class="space-y-1 list-disc list-inside">
            <li><strong>DXY Trade-Weighted Dollar (10%):</strong> Dollar weakness supports risk assets globally.</li>
            <li><strong>Yield Curve 10Y-2Y (10%):</strong> Steepening curve = improving growth outlook.</li>
          </ul>
        </div>
        <div>
          <h4 class="text-gray-300 font-semibold mb-2">Valuation & Activity (30%)</h4>
          <ul class="space-y-1 list-disc list-inside">
            <li><strong>ISM Manufacturing (10%):</strong> Business cycle leading indicator. Manual input required.</li>
            <li><strong>Buffett Indicator (10%):</strong> Market cap / GDP. Valuation warning when >200%.</li>
            <li><strong>Mfg Composite (10%):</strong> FRED industrial production, capacity utilization, durable goods.</li>
          </ul>
        </div>
      </div>
      <div class="mt-4 pt-4 border-t border-gray-700/50 text-xs text-gray-500">
        <p><strong>Seasons:</strong> Winter (0-35) = Defensive | Spring (35-55) = Accumulate | Summer (55-75) = Risk On | Fall (75-100) = Reduce Risk</p>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================================
// CONFIGURATION v2.1
// ============================================================================
const FRED_PROXY_URL = 'https://fred-proxy.ethan-109.workers.dev';

// FRED series configuration - v2.1 with fixes
// Key changes:
// - WILL5000PRFC -> WILL5000IND (more reliable, divide by 10 for price)
// - Increased limits for YoY calculations (need 52 weeks of weekly data)
// - Added TGA/RRP historical data for proper Net Liquidity YoY
const FRED_SERIES = [
  // Liquidity - need 55 weeks for YoY calculation
  { id: 'WALCL', key: 'fedBalanceSheet', limit: 55, label: 'Fed Balance Sheet' },
  { id: 'WTREGEN', key: 'tga', limit: 55, label: 'Treasury General Account' },
  { id: 'RRPONTSYD', key: 'rrp', limit: 55, label: 'Reverse Repo' },
  // M2 Money Supply - need 15 months for YoY
  { id: 'M2SL', key: 'm2us', limit: 15, label: 'US M2 Money Supply' },
  // Bank Lending - need 15 months for YoY
  { id: 'TOTLL', key: 'bankLending', limit: 15, label: 'Total Loans & Leases' },
  // Buffett Indicator components
  // Using WILL5000IND (index) instead of WILL5000PRFC (discontinued/unreliable)
  // WILL5000IND is the Full Cap Index - multiply by ~1.15 to approximate market cap in billions
  { id: 'WILL5000IND', key: 'wilshire', limit: 5, label: 'Wilshire 5000 Index' },
  { id: 'GDP', key: 'gdp', limit: 10, label: 'Nominal GDP' },
  // Financial Conditions
  { id: 'BAMLH0A0HYM2', key: 'hySpread', limit: 5, label: 'HY Credit Spread' },
  { id: 'T10Y2Y', key: 'yieldCurve', limit: 5, label: '10Y-2Y Yield Curve' },
  { id: 'DTWEXBGS', key: 'dxy', limit: 5, label: 'Trade-Weighted Dollar' },
  // Manufacturing
  { id: 'IPMAN', key: 'ipman', limit: 15, label: 'Industrial Production: Mfg' },
  { id: 'MCUMFN', key: 'mcumfn', limit: 5, label: 'Capacity Utilization: Mfg' },
  { id: 'DGORDER', key: 'dgorder', limit: 15, label: 'Durable Goods Orders' }
];

// ============================================================================
// MACRO APP v2.1
// ============================================================================
const MacroApp = {
  ismValue: null,
  ismPrevious: null,
  ismSavedDate: null,
  macroData: {},
  rawObservations: {}, // Store raw observations for YoY calculations
  globalM2Data: null,
  debugInfo: {},
  dataErrors: [], // Track which series failed

  async init() {
    if (!FRED_PROXY_URL) {
      this.showError('FRED_PROXY_URL is not configured.');
      return;
    }

    document.getElementById('debug-proxy').textContent = FRED_PROXY_URL.replace('https://', '');

    await Promise.all([
      this.fetchFREDData(),
      this.fetchGlobalM2()
    ]);
  },

  async refresh() {
    // Show loading state
    const icon = document.getElementById('refresh-icon');
    icon.classList.add('animate-spin');
    document.getElementById('data-status').textContent = 'Refreshing...';
    document.getElementById('data-status').className = 'text-yellow-400';
    
    // Clear caches and refetch
    this.macroData = {};
    this.rawObservations = {};
    this.globalM2Data = null;
    this.dataErrors = [];
    
    await Promise.all([
      this.fetchFREDData(),
      this.fetchGlobalM2()
    ]);
    
    icon.classList.remove('animate-spin');
  },

  async fetchFREDData() {
    try {
      document.getElementById('data-status').textContent = 'Fetching FRED data...';
      document.getElementById('data-status').className = 'text-yellow-400';

      const results = await Promise.all(
        FRED_SERIES.map(async s => {
          const url = `${FRED_PROXY_URL}?series_id=${s.id}&limit=${s.limit}`;
          try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            return { ...s, data, success: true, error: null };
          } catch (e) {
            return { ...s, data: null, success: false, error: e.message };
          }
        })
      );

      let latestDate = null;
      let failedSeries = [];
      const debugHtml = [];

      results.forEach(r => {
        if (r.success && r.data?.observations?.length > 0) {
          const obs = r.data.observations;
          const val = parseFloat(obs[0].value);
          const date = obs[0].date;

          if (!isNaN(val)) {
            this.macroData[r.key] = val;
            this.rawObservations[r.key] = obs; // Store all observations for YoY

            if (!latestDate || date > latestDate) latestDate = date;

            this.debugInfo[r.id] = { value: val, date, success: true };
            debugHtml.push(`<div class="flex justify-between"><span class="text-green-400">${r.id}</span><span>${val.toFixed(2)} (${date})</span></div>`);

            // Get YoY values for monthly series (12 months ago)
            if (r.key === 'm2us' && obs.length >= 13) {
              this.macroData.m2usYoY = parseFloat(obs[12].value) || val;
            }
            if (r.key === 'bankLending' && obs.length >= 13) {
              this.macroData.bankLendingYoY = parseFloat(obs[12].value) || val;
            }
            if (r.key === 'ipman' && obs.length >= 13) {
              this.macroData.ipmanYoY = parseFloat(obs[12].value) || val;
            }
            if (r.key === 'dgorder' && obs.length >= 13) {
              this.macroData.dgorderYoY = parseFloat(obs[12].value) || val;
            }
          } else {
            failedSeries.push(r.id);
            this.dataErrors.push({ id: r.id, reason: 'Invalid value' });
          }
        } else {
          failedSeries.push(r.id);
          this.dataErrors.push({ id: r.id, reason: r.error || 'No data' });
          debugHtml.push(`<div class="flex justify-between"><span class="text-red-400">${r.id}</span><span>Failed: ${r.error || 'No data'}</span></div>`);
        }
      });

      document.getElementById('debug-series').innerHTML = debugHtml.join('');
      document.getElementById('debug-timestamp').textContent = latestDate || '--';

      if (failedSeries.length === 0) {
        document.getElementById('data-status').textContent = `Live data as of ${latestDate}`;
        document.getElementById('data-status').className = 'text-green-400';
      } else {
        document.getElementById('data-status').textContent = `Partial data (${failedSeries.length} series failed)`;
        document.getElementById('data-status').className = 'text-orange-400';
      }

      this.calculate();
    } catch (error) {
      console.error('FRED fetch error:', error);
      document.getElementById('data-status').textContent = 'Error fetching data';
      document.getElementById('data-status').className = 'text-red-400';
    }
  },

  async fetchGlobalM2() {
    // Try to fetch aggregated Global M2 from proxy
    // Falls back to US M2 only if not available
    try {
      const res = await fetch(`${FRED_PROXY_URL.replace('fred-proxy', 'global-macro-proxy')}/global-m2`);
      if (res.ok) {
        this.globalM2Data = await res.json();
      }
    } catch (e) {
      console.log('Global M2 endpoint not available, using US M2 only');
    }
  },

  setISM(val) {
    const v = parseFloat(val);
    if (!isNaN(v) && v > 0 && v < 100) {
      this.ismValue = v;
      this.ismSavedDate = new Date().toISOString();
      localStorage.setItem('ism_value', v);
      localStorage.setItem('ism_saved_date', this.ismSavedDate);
      this.updateISMDateDisplay();
    }
  },

  setISMPrev(val) {
    const v = parseFloat(val);
    if (!isNaN(v) && v > 0 && v < 100) {
      this.ismPrevious = v;
      localStorage.setItem('ism_previous', v);
    }
  },

  loadISMFromStorage() {
    const saved = localStorage.getItem('ism_value');
    const savedPrev = localStorage.getItem('ism_previous');
    const savedDate = localStorage.getItem('ism_saved_date');
    
    if (saved) {
      this.ismValue = parseFloat(saved);
      document.getElementById('input-ism').value = saved;
    }
    if (savedPrev) {
      this.ismPrevious = parseFloat(savedPrev);
      document.getElementById('input-ism-prev').value = savedPrev;
    }
    if (savedDate) {
      this.ismSavedDate = savedDate;
      this.updateISMDateDisplay();
    }
  },

  updateISMDateDisplay() {
    const el = document.getElementById('ism-saved-date');
    if (this.ismSavedDate) {
      const date = new Date(this.ismSavedDate);
      const daysSince = Math.floor((Date.now() - date.getTime()) / (1000 * 60 * 60 * 24));
      if (daysSince > 30) {
        el.textContent = `⚠️ ISM data is ${daysSince} days old`;
        el.className = 'text-xs text-orange-400';
      } else {
        el.textContent = `Saved ${date.toLocaleDateString()}`;
        el.className = 'text-xs text-gray-500';
      }
    }
  },

  calculateMfgComposite() {
    const d = this.macroData;
    let score = 50;

    // Industrial Production YoY
    if (d.ipman && d.ipmanYoY) {
      const ipYoY = ((d.ipman - d.ipmanYoY) / d.ipmanYoY * 100);
      score += ipYoY * 3;
    }

    // Capacity Utilization
    if (d.mcumfn) {
      score += (d.mcumfn - 77) * 2;
    }

    // Durable Goods YoY
    if (d.dgorder && d.dgorderYoY) {
      const dgYoY = ((d.dgorder - d.dgorderYoY) / d.dgorderYoY * 100);
      score += dgYoY * 1.5;
    }

    return Math.max(0, Math.min(100, score));
  },

  // Helper to safely get value from N observations ago
  getHistoricalValue(key, periodsAgo) {
    const obs = this.rawObservations[key];
    if (!obs || obs.length <= periodsAgo) return null;
    const val = parseFloat(obs[periodsAgo].value);
    return isNaN(val) ? null : val;
  },

  calculate() {
    const d = this.macroData;
    this.loadISMFromStorage();

    // Ensure minimum required data
    if (!d.fedBalanceSheet || !d.tga || d.rrp === undefined || !d.hySpread || d.yieldCurve === undefined || !d.dxy) {
      console.error('Missing required macro data', d);
      this.showError('Missing critical data');
      return;
    }

    // === CALCULATIONS ===

    // Net Liquidity (current)
    const fedBs = d.fedBalanceSheet * 1e6; // Convert millions to actual
    const tga = d.tga * 1e6;
    const rrp = d.rrp * 1e9; // RRP is in billions
    const netLiq = fedBs - tga - rrp;

    // Net Liquidity YoY - FIXED: Now uses all components from 52 weeks ago
    const fedBs52 = this.getHistoricalValue('fedBalanceSheet', 52);
    const tga52 = this.getHistoricalValue('tga', 52);
    const rrp52 = this.getHistoricalValue('rrp', 52);
    
    let netLiqYoY = 0;
    if (fedBs52 !== null && tga52 !== null && rrp52 !== null) {
      const netLiq52 = (fedBs52 * 1e6) - (tga52 * 1e6) - (rrp52 * 1e9);
      if (netLiq52 !== 0) {
        netLiqYoY = ((netLiq - netLiq52) / Math.abs(netLiq52)) * 100;
      }
    } else {
      // Fallback: just use Fed BS YoY if we don't have full historical data
      const fedBsYoY = fedBs52 ? (fedBs52 * 1e6) : fedBs;
      netLiqYoY = ((fedBs - fedBsYoY) / fedBsYoY) * 100;
    }

    // US M2 YoY
    const m2YoY = d.m2us && d.m2usYoY ? ((d.m2us - d.m2usYoY) / d.m2usYoY * 100) : 0;

    // Global M2 (use aggregated if available, otherwise US only)
    let globalM2YoY = m2YoY;
    let globalM2Total = d.m2us ? d.m2us / 1000 : 0; // Convert to trillions
    if (this.globalM2Data?.globalM2) {
      globalM2YoY = this.globalM2Data.globalM2.yoyGrowth;
      globalM2Total = this.globalM2Data.globalM2.totalUSD / 1000;
    }

    // Bank Lending YoY
    const lendingYoY = d.bankLending && d.bankLendingYoY
      ? ((d.bankLending - d.bankLendingYoY) / d.bankLendingYoY * 100) : 0;

    // Buffett Indicator - FIXED: Handle missing/zero Wilshire data gracefully
    // WILL5000IND is an index; approximate market cap = index * 1.15 (rough conversion)
    const wilshireIndex = d.wilshire;
    const wilshireMarketCap = wilshireIndex ? wilshireIndex * 1.15 : null; // Billions USD approx
    const gdp = d.gdp;
    
    let buffettIndicator = null;
    let buffettDataError = false;
    
    if (wilshireMarketCap && wilshireMarketCap > 1000 && gdp && gdp > 1000) {
      // Both values should be in billions, so ratio * 100 = percentage
      buffettIndicator = (wilshireMarketCap / gdp) * 100;
    } else {
      buffettDataError = true;
      buffettIndicator = null;
    }

    // Financial Conditions Index (0-100, higher = looser)
    let fci = 50;
    fci += (110 - d.dxy) * 2.5;
    fci += (5 - d.hySpread) * 6;
    fci += d.yieldCurve * 10;
    fci = Math.max(0, Math.min(100, fci));

    // Manufacturing composite
    const mfgComposite = this.calculateMfgComposite();

    // === SCORING ===
    const scores = [];

    // 1. Global M2 YoY (15%)
    let m2Score = 0, m2Signal = 'Neutral';
    if (globalM2YoY > 6) { m2Score = 15; m2Signal = 'Bullish'; }
    else if (globalM2YoY > 2) { m2Score = 7; m2Signal = 'Neutral'; }
    else if (globalM2YoY > 0) { m2Score = 0; m2Signal = 'Caution'; }
    else { m2Score = -8; m2Signal = 'Bearish'; }
    scores.push({ name: 'Global M2 YoY', value: globalM2YoY.toFixed(1) + '%', signal: m2Signal, weight: 15, score: m2Score });

    // 2. Net Liquidity YoY (15%)
    let liqScore = 0, liqSignal = 'Neutral';
    if (netLiqYoY > 5) { liqScore = 15; liqSignal = 'Bullish'; }
    else if (netLiqYoY > 0) { liqScore = 7; liqSignal = 'Neutral'; }
    else if (netLiqYoY > -5) { liqScore = 0; liqSignal = 'Caution'; }
    else { liqScore = -8; liqSignal = 'Bearish'; }
    scores.push({ name: 'Net Liquidity YoY', value: netLiqYoY.toFixed(1) + '%', signal: liqSignal, weight: 15, score: liqScore });

    // 3. Bank Lending YoY (10%)
    let lendScore = 0, lendSignal = 'Neutral';
    if (lendingYoY > 5) { lendScore = 10; lendSignal = 'Bullish'; }
    else if (lendingYoY > 2) { lendScore = 5; lendSignal = 'Neutral'; }
    else if (lendingYoY > 0) { lendScore = 0; lendSignal = 'Caution'; }
    else { lendScore = -5; lendSignal = 'Bearish'; }
    scores.push({ name: 'Bank Lending YoY', value: lendingYoY.toFixed(1) + '%', signal: lendSignal, weight: 10, score: lendScore });

    // 4. DXY (10%)
    let dxyScore = 0, dxySignal = 'Neutral';
    if (d.dxy < 105) { dxyScore = 10; dxySignal = 'Bullish'; }
    else if (d.dxy < 110) { dxyScore = 5; dxySignal = 'Neutral'; }
    else if (d.dxy < 115) { dxyScore = 0; dxySignal = 'Caution'; }
    else { dxyScore = -5; dxySignal = 'Bearish'; }
    scores.push({ name: 'Trade-Weighted Dollar', value: d.dxy.toFixed(1), signal: dxySignal, weight: 10, score: dxyScore });

    // 5. HY Spread (10%)
    let hyScore = 0, hySignal = 'Neutral';
    if (d.hySpread < 4) { hyScore = 10; hySignal = 'Bullish'; }
    else if (d.hySpread < 5) { hyScore = 5; hySignal = 'Neutral'; }
    else if (d.hySpread < 6) { hyScore = 0; hySignal = 'Caution'; }
    else { hyScore = -5; hySignal = 'Bearish'; }
    scores.push({ name: 'HY Credit Spread', value: d.hySpread.toFixed(2) + '%', signal: hySignal, weight: 10, score: hyScore });

    // 6. Yield Curve (10%)
    let curveScore = 0, curveSignal = 'Neutral';
    if (d.yieldCurve > 0.5) { curveScore = 10; curveSignal = 'Bullish'; }
    else if (d.yieldCurve > 0) { curveScore = 5; curveSignal = 'Neutral'; }
    else if (d.yieldCurve > -0.3) { curveScore = 0; curveSignal = 'Caution'; }
    else { curveScore = -5; curveSignal = 'Bearish'; }
    scores.push({ name: '10Y-2Y Yield Curve', value: d.yieldCurve.toFixed(2) + '%', signal: curveSignal, weight: 10, score: curveScore });

    // 7. ISM Manufacturing (10%)
    let ismScore = 0, ismSignal = 'Neutral';
    const ismVal = this.ismValue;
    if (ismVal) {
      if (ismVal > 52) { ismScore = 10; ismSignal = 'Bullish'; }
      else if (ismVal > 50) { ismScore = 5; ismSignal = 'Neutral'; }
      else if (ismVal > 48) { ismScore = 0; ismSignal = 'Caution'; }
      else { ismScore = -5; ismSignal = 'Bearish'; }
      scores.push({ name: 'ISM Manufacturing', value: ismVal.toFixed(1), signal: ismSignal, weight: 10, score: ismScore });
    } else {
      scores.push({ name: 'ISM Manufacturing', value: '--', signal: 'N/A', weight: 10, score: 0 });
    }

    // 8. Buffett Indicator (10%) - FIXED: Graceful handling of missing data
    let buffScore = 0, buffSignal = 'Neutral';
    if (buffettIndicator !== null) {
      if (buffettIndicator < 150) { buffScore = 10; buffSignal = 'Bullish'; }
      else if (buffettIndicator < 180) { buffScore = 5; buffSignal = 'Neutral'; }
      else if (buffettIndicator < 200) { buffScore = 0; buffSignal = 'Caution'; }
      else { buffScore = -5; buffSignal = 'Bearish'; }
      scores.push({ name: 'Buffett Indicator', value: buffettIndicator.toFixed(0) + '%', signal: buffSignal, weight: 10, score: buffScore });
    } else {
      scores.push({ name: 'Buffett Indicator', value: 'N/A', signal: 'Data Error', weight: 10, score: 0 });
      buffSignal = 'Data Error';
    }

    // 9. Manufacturing Composite (10%)
    let mfgScore = 0, mfgSignal = 'Neutral';
    if (mfgComposite > 60) { mfgScore = 10; mfgSignal = 'Bullish'; }
    else if (mfgComposite > 50) { mfgScore = 5; mfgSignal = 'Neutral'; }
    else if (mfgComposite > 40) { mfgScore = 0; mfgSignal = 'Caution'; }
    else { mfgScore = -5; mfgSignal = 'Bearish'; }
    scores.push({ name: 'Mfg Composite', value: mfgComposite.toFixed(0), signal: mfgSignal, weight: 10, score: mfgScore });

    // === TOTALS ===
    const totalScore = scores.reduce((a, s) => a + s.score, 0);
    const maxScore = scores.reduce((a, s) => a + s.weight, 0);
    const cyclePos = 50 + (totalScore / maxScore) * 50;

    // Season
    let season, mainSignal;
    if (cyclePos >= 75) { season = 'SUMMER'; mainSignal = 'Risk On'; }
    else if (cyclePos >= 55) { season = 'SPRING'; mainSignal = 'Accumulate'; }
    else if (cyclePos >= 35) { season = 'FALL'; mainSignal = 'Reduce Risk'; }
    else { season = 'WINTER'; mainSignal = 'Defensive'; }

    // Update UI
    this.updateUI({
      netLiq, netLiqYoY, fci, mfgComposite,
      globalM2YoY, globalM2Total, lendingYoY,
      buffettIndicator, wilshireMarketCap, gdp, buffettDataError,
      scores, cyclePos, season, mainSignal, totalScore,
      liqSignal, m2Signal, lendSignal, buffSignal, mfgSignal
    });
  },

  updateUI(data) {
    const fmt = (n) => '$' + (n / 1e12).toFixed(2) + 'T';
    const fmtT = (n) => '$' + n.toFixed(1) + 'T';
    const d = this.macroData;

    // Header
    document.getElementById('cycle-score').textContent = data.cyclePos.toFixed(0);
    document.getElementById('cycle-season').textContent = data.season;
    document.getElementById('main-signal').textContent = data.mainSignal;

    const seasonColors = { 'SUMMER': 'text-green-400', 'SPRING': 'text-yellow-400', 'FALL': 'text-orange-400', 'WINTER': 'text-blue-400' };
    document.getElementById('cycle-season').className = 'text-lg font-semibold ' + (seasonColors[data.season] || 'text-gray-400');
    document.getElementById('cycle-score').className = 'text-2xl font-bold ' + (seasonColors[data.season] || 'text-gray-400');

    // Needle
    document.getElementById('cycle-needle').style.left = data.cyclePos + '%';

    // Probability grid - FIXED: Now sums to 100%
    this.updateProbabilityGrid(data.cyclePos);

    // Data cards
    // Global M2
    document.getElementById('global-m2').textContent = fmtT(data.globalM2Total);
    document.getElementById('m2-yoy').textContent = (data.globalM2YoY > 0 ? '+' : '') + data.globalM2YoY.toFixed(1) + '%';
    document.getElementById('m2-yoy').className = data.globalM2YoY > 0 ? 'text-green-400' : 'text-red-400';

    // M2 component YoYs (if available from global endpoint)
    if (this.globalM2Data?.globalM2?.components) {
      const c = this.globalM2Data.globalM2.components;
      document.getElementById('m2-us-yoy').textContent = c.us?.yoyGrowth?.toFixed(1) + '%' || '--%';
      document.getElementById('m2-eu-yoy').textContent = c.euro?.yoyGrowth?.toFixed(1) + '%' || '--%';
      document.getElementById('m2-jp-yoy').textContent = c.japan?.yoyGrowth?.toFixed(1) + '%' || '--%';
      document.getElementById('m2-cn-yoy').textContent = c.china?.yoyGrowth?.toFixed(1) + '%' || '--%';
    }

    // Net Liquidity
    document.getElementById('net-liquidity').textContent = fmt(data.netLiq);
    document.getElementById('liq-yoy').textContent = (data.netLiqYoY > 0 ? '+' : '') + data.netLiqYoY.toFixed(1) + '%';
    document.getElementById('liq-yoy').className = data.netLiqYoY > 0 ? 'text-green-400' : 'text-red-400';

    // Bank Lending
    document.getElementById('bank-lending').textContent = '$' + (d.bankLending / 1000).toFixed(2) + 'T';
    document.getElementById('lending-yoy').textContent = (data.lendingYoY > 0 ? '+' : '') + data.lendingYoY.toFixed(1) + '%';
    document.getElementById('lending-yoy').className = data.lendingYoY > 0 ? 'text-green-400' : 'text-red-400';

    // Buffett Indicator - FIXED: Handle missing data
    if (data.buffettDataError || data.buffettIndicator === null) {
      document.getElementById('buffett-value').textContent = 'N/A';
      document.getElementById('buffett-value').className = 'text-2xl font-bold text-orange-400';
      document.getElementById('wilshire-value').textContent = 'Data Error';
      document.getElementById('wilshire-value').className = 'text-gray-500';
    } else {
      document.getElementById('buffett-value').textContent = data.buffettIndicator.toFixed(0) + '%';
      document.getElementById('buffett-value').className = 'text-2xl font-bold text-gray-100';
      document.getElementById('wilshire-value').textContent = '$' + (data.wilshireMarketCap / 1000).toFixed(1) + 'T';
      document.getElementById('wilshire-value').className = 'text-gray-300';
    }
    document.getElementById('gdp-value').textContent = data.gdp ? '$' + (data.gdp / 1000).toFixed(1) + 'T' : 'N/A';

    // Financial Conditions
    document.getElementById('fci-score').textContent = data.fci.toFixed(0);
    document.getElementById('fci-dxy').textContent = d.dxy.toFixed(1);
    document.getElementById('fci-hy').textContent = d.hySpread.toFixed(2) + '%';
    document.getElementById('fci-curve').textContent = d.yieldCurve.toFixed(2) + '%';

    // ISM / Manufacturing
    document.getElementById('ism-value').textContent = this.ismValue ? this.ismValue.toFixed(1) : '--';
    document.getElementById('mfg-composite').textContent = data.mfgComposite.toFixed(0);
    document.getElementById('cap-util').textContent = d.mcumfn ? d.mcumfn.toFixed(1) + '%' : '--%';

    // Signal badges
    const signalColors = {
      'Bullish': 'bg-green-500/20 text-green-400',
      'Neutral': 'bg-yellow-500/20 text-yellow-400',
      'Caution': 'bg-orange-500/20 text-orange-400',
      'Bearish': 'bg-red-500/20 text-red-400',
      'N/A': 'bg-gray-500/20 text-gray-400',
      'Data Error': 'bg-red-500/20 text-red-400'
    };

    const setSignal = (id, signal) => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = signal;
        el.className = 'text-xs px-2 py-0.5 rounded ' + (signalColors[signal] || signalColors['N/A']);
      }
    };

    setSignal('m2-signal', data.m2Signal);
    setSignal('liq-signal', data.liqSignal);
    setSignal('lending-signal', data.lendSignal);
    setSignal('buffett-signal', data.buffSignal);
    setSignal('fci-signal', data.fci > 60 ? 'Bullish' : data.fci > 40 ? 'Neutral' : 'Caution');
    setSignal('mfg-signal', data.mfgSignal);

    // Scorecard table
    document.getElementById('scorecard-body').innerHTML = data.scores.map(s => {
      const signalClass = signalColors[s.signal]?.split(' ')[1] || 'text-gray-400';
      const scoreClass = s.score > 0 ? 'text-green-400' : s.score < 0 ? 'text-red-400' : 'text-gray-400';
      return `
        <tr class="border-b border-gray-800/50">
          <td class="py-2 text-gray-300">${s.name}</td>
          <td class="py-2 text-right text-gray-100 font-mono">${s.value}</td>
          <td class="py-2 text-right ${signalClass}">${s.signal}</td>
          <td class="py-2 text-right text-gray-500">${s.weight}%</td>
          <td class="py-2 text-right font-semibold ${scoreClass}">${s.score > 0 ? '+' : ''}${s.score}</td>
        </tr>
      `;
    }).join('');

    document.getElementById('total-score').textContent = (data.totalScore > 0 ? '+' : '') + data.totalScore;
    document.getElementById('total-score').className = 'pt-3 text-right font-semibold ' + (data.totalScore > 0 ? 'text-green-400' : data.totalScore < 0 ? 'text-red-400' : 'text-gray-400');
  },

  // FIXED: Probability grid now sums to 100%
  updateProbabilityGrid(cyclePos) {
    // Map cycle position to probability distribution
    // cyclePos: 0-100, where 0=Winter, 100=Fall
    
    let bullish, neutral, caution, bearish;
    
    if (cyclePos >= 75) {
      // Summer/Risk On zone
      bullish = 60 + (cyclePos - 75);
      neutral = 25 - (cyclePos - 75) * 0.5;
      caution = 10;
      bearish = 5;
    } else if (cyclePos >= 55) {
      // Spring/Accumulate zone
      bullish = 30 + (cyclePos - 55) * 1.5;
      neutral = 45 - (cyclePos - 55);
      caution = 15;
      bearish = 10 - (cyclePos - 55) * 0.5;
    } else if (cyclePos >= 35) {
      // Fall/Reduce Risk zone
      bullish = 15 + (cyclePos - 35) * 0.75;
      neutral = 30 + (cyclePos - 35) * 0.75;
      caution = 35 - (cyclePos - 35) * 0.5;
      bearish = 20 - (cyclePos - 35) * 0.5;
    } else {
      // Winter/Defensive zone
      bullish = 5 + cyclePos * 0.3;
      neutral = 15 + cyclePos * 0.4;
      caution = 30;
      bearish = 50 - cyclePos * 0.7;
    }

    // Normalize to ensure sum = 100
    const total = bullish + neutral + caution + bearish;
    bullish = Math.round((bullish / total) * 100);
    neutral = Math.round((neutral / total) * 100);
    caution = Math.round((caution / total) * 100);
    bearish = 100 - bullish - neutral - caution; // Ensure exact 100

    document.getElementById('prob-bullish').textContent = bullish + '%';
    document.getElementById('prob-neutral').textContent = neutral + '%';
    document.getElementById('prob-caution').textContent = caution + '%';
    document.getElementById('prob-bearish').textContent = Math.max(0, bearish) + '%';
  },

  showError(msg) {
    document.getElementById('data-status').textContent = msg;
    document.getElementById('data-status').className = 'text-red-400';
  }
};

document.addEventListener('DOMContentLoaded', () => MacroApp.init());
</script>
